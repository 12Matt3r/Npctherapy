<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPC Therapy - Ultimate Combined Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            font-family: 'Press Start 2P', monospace;
            text-align: center;
            image-rendering: pixelated;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }

        /* CRT Filter Overlay */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 0, 0.1) 2px,
                rgba(0, 255, 0, 0.1) 4px
            );
            z-index: 9999;
            opacity: 0.3;
            animation: scanlines 0.1s linear infinite;
        }

        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        #gameContainer {
            max-width: 900px;
            margin: 0 auto;
            background: #000;
            border: 4px solid #6ff;
            box-shadow: 0 0 30px rgba(102, 255, 255, 0.5);
            position: relative;
            min-height: 650px;
            transition: background 0.5s ease;
            overflow: hidden;
        }

        #startScreen, #habitatScreen, #therapyOffice, #sessionComplete {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1000;
        }

        #habitatScreen, #therapyOffice, #sessionComplete {
            background: linear-gradient(135deg, #101820 0%, #1a1a2e 100%);
        }

        .screen-title {
            font-size: 16px;
            margin-bottom: 20px;
            color: #6ff;
            text-shadow: 2px 2px 0px #000;
        }

        /* Habitat Screen Styles */
        .habitat-image {
            width: 100%;
            max-width: 500px;
            height: 300px;
            background-size: cover;
            background-position: center;
            border: 4px solid #6ff;
            margin: 20px 0;
            position: relative;
        }

        .npc-sprite {
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: absolute;
            bottom: 20px;
            right: 20px;
            filter: drop-shadow(0 0 10px rgba(102, 255, 255, 0.8));
        }

        .habitat-description {
            font-size: 10px;
            max-width: 600px;
            margin: 20px;
            line-height: 1.5;
            color: #ccc;
        }

        /* NPC Creation */
        #npcCreation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 1001;
            overflow-y: auto;
        }

        /* Glitch Screen */
        #glitchScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            z-index: 1002;
            animation: glitch 2s ease-in-out;
        }

        @keyframes glitch {
            0% { filter: none; }
            25% { filter: hue-rotate(90deg) contrast(200%); }
            50% { filter: hue-rotate(180deg) invert(100%); }
            75% { filter: hue-rotate(270deg) contrast(200%); }
            100% { filter: none; }
        }

        .form-group {
            margin: 15px 0;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #6ff;
            font-size: 10px;
            margin-bottom: 5px;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #6ff;
            color: #fff;
            font-family: inherit;
            font-size: 10px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .start-btn, .create-btn, .transition-btn, .control-btn, .finish-btn {
            background: #6ff;
            border: none;
            padding: 12px 24px;
            color: #000;
            font-family: 'Press Start 2P';
            font-size: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .start-btn:hover, .create-btn:hover, .transition-btn:hover, .control-btn:hover, .finish-btn:hover {
            background: #8ff;
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(102, 255, 255, 0.5);
        }

        /* Main Game Area with Side Panel */
        #mainGameArea {
            display: flex;
            height: 100%;
        }

        #leftPanel {
            width: 60%;
            position: relative;
        }

        #rightPanel {
            width: 40%;
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid #6ff;
            display: flex;
            flex-direction: column;
        }

        /* Therapy Office */
        .therapy-office-bg {
            width: 100%;
            height: 100%;
            background-image: url('imgs/therapy_office.png');
            background-size: cover;
            background-position: center;
            position: relative;
            transition: filter 1s ease-in-out, background-color 1s ease-in-out;
        }

        /* Dynamic Atmosphere Styles */
        .atmosphere-hopeful {
            filter: brightness(1.2) saturate(1.1);
            background-color: rgba(255, 255, 102, 0.1); /* Faint yellow glow */
        }
        .atmosphere-enraged {
            filter: contrast(1.4) saturate(1.5);
            background-color: rgba(255, 51, 51, 0.2); /* Pulsing red overlay */
            animation: pulse-red 2s infinite;
        }
        .atmosphere-serene {
            filter: brightness(1.1) contrast(0.9);
            background-color: rgba(102, 153, 255, 0.15); /* Calm blue hue */
        }
        .atmosphere-glitched {
            animation: digital-glitch 0.5s infinite;
        }

        @keyframes pulse-red {
            0% { background-color: rgba(255, 51, 51, 0.2); }
            50% { background-color: rgba(255, 51, 51, 0.3); }
            100% { background-color: rgba(255, 51, 51, 0.2); }
        }

        @keyframes digital-glitch {
            0% { filter: none; }
            20% { filter: hue-rotate(10deg) saturate(1.5); }
            40% { transform: translateX(2px); }
            60% { filter: hue-rotate(-10deg); }
            80% { transform: translateX(-2px); }
            100% { filter: none; }
        }

        .npc-on-couch {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: all 0.5s ease-in-out;
            filter: drop-shadow(0 0 15px rgba(102, 255, 255, 0.6));
        }

        /* NPC State Animations */
        .npc-anxious {
            animation: anxious-shake 2s infinite;
        }

        .npc-crying {
            animation: crying-pulse 1.5s infinite;
        }

        .npc-glitched {
            animation: glitch-shake 0.3s infinite;
        }

        .npc-calm {
            animation: gentle-breathe 3s infinite;
        }

        @keyframes anxious-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        @keyframes crying-pulse {
            0%, 100% { opacity: 1; filter: brightness(1); }
            50% { opacity: 0.7; filter: brightness(0.8) drop-shadow(0 0 10px #6ff); }
        }

        @keyframes glitch-shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-2px, 2px) rotate(-1deg); }
            40% { transform: translate(-2px, -2px) rotate(1deg); }
            60% { transform: translate(2px, 2px) rotate(0deg); }
            80% { transform: translate(2px, -2px) rotate(-1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        @keyframes gentle-breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Emotion Meter */
        .emotion-meter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #6ff;
            padding: 10px;
            font-size: 8px;
            z-index: 10;
        }

        .emotion-bar {
            width: 100px;
            height: 6px;
            background: #333;
            margin: 5px 0;
            border: 1px solid #666;
        }

        .emotion-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .hope { background: linear-gradient(to right, #ff6b6b, #feca57); }
        .rage { background: linear-gradient(to right, #6b47dc, #ee5a52); }
        .acceptance { background: linear-gradient(to right, #4834d4, #686de0); }

        /* Session Status */
        .session-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #6ff;
            padding: 10px;
            font-size: 8px;
            z-index: 10;
        }

        /* Dialogue Box */
        .dialogue-box {
            position: absolute;
            bottom: 150px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #6ff;
            padding: 15px;
            max-height: 180px;
            overflow-y: auto;
            z-index: 10;
        }

        .npc-name {
            color: #6ff;
            font-size: 11px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #6ff;
        }

        /* Enhanced Questions - FIXED: Show 4 at once */
        .questions-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .question {
            background: rgba(102, 255, 255, 0.1);
            border: 1px solid #6ff;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 8px;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .question:hover {
            background: rgba(102, 255, 255, 0.2);
            transform: scale(1.02);
            border-color: #8ff;
        }

        .question.selected {
            background: rgba(102, 255, 255, 0.3);
            border-color: #8ff;
            box-shadow: 0 0 10px rgba(102, 255, 255, 0.3);
        }

        .question-type {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 6px;
            opacity: 0.7;
        }

        .empathetic { border-left: 3px solid #ff6b6b; }
        .challenging { border-left: 3px solid #ee5a52; }
        .insightful { border-left: 3px solid #feca57; }
        .supportive { border-left: 3px solid #48cae4; }

        /* NPC Response */
        .npc-response {
            background: rgba(102, 255, 255, 0.05);
            border: 1px solid #6ff;
            padding: 10px;
            margin: 10px 0;
            font-size: 8px;
            border-radius: 3px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .response-speaking {
            color: #6ff;
            font-style: italic;
            animation: pulse 1s infinite;
        }

        /* Control Panel */
        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .control-btn {
            background: #6ff;
            border: none;
            padding: 8px 16px;
            color: #000;
            font-family: 'Press Start 2P';
            font-size: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #8ff;
        }

        .control-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }

        /* Side Panel Controls */
        #controls {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 8px;
        }

        .panel-btn {
            background: #444;
            border: 1px solid #6ff;
            color: #6ff;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 8px;
            transition: all 0.3s ease;
        }

        .panel-btn:hover, .panel-btn.active {
            background: #6ff;
            color: #000;
        }

        /* Panels */
        .panel {
            padding: 15px;
            height: 250px;
            overflow-y: auto;
        }

        .note-entry {
            background: rgba(102, 255, 255, 0.1);
            border: 1px solid #6ff;
            padding: 8px;
            margin: 5px 0;
            font-size: 8px;
        }

        .note-entry textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-family: inherit;
            font-size: 8px;
            resize: vertical;
        }

        #generatedImage {
            width: 100%;
            height: 150px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: 1px solid #6ff;
            margin: 10px 0;
        }

        #imageAnalysis {
            font-size: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #666;
            margin: 10px 0;
            min-height: 60px;
        }

        /* Advanced Features */
        .fourth-wall-break {
            background: linear-gradient(45deg, #000, #333);
            border: 2px solid #f66;
            animation: glitch 0.5s infinite;
            padding: 10px;
            margin: 10px 0;
            font-size: 8px;
        }

        .transference-text {
            color: #f6f;
            font-size: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .connected-stories {
            color: #ff6;
            font-size: 7px;
            font-style: italic;
            margin: 5px 0;
        }

        .breakthrough-log {
            background: rgba(102, 255, 255, 0.1);
            border: 1px solid #6ff;
            padding: 8px;
            margin: 5px 0;
            font-size: 8px;
        }

        /* Session Complete */
        .item-reward {
            background: linear-gradient(45deg, #6ff, #8ff);
            border: 3px solid #fff;
            padding: 15px;
            margin: 20px;
            font-size: 12px;
            color: #000;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(102, 255, 255, 0.5); }
            to { box-shadow: 0 0 30px rgba(102, 255, 255, 0.8); }
        }

        .fade-transition {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .fade-in {
            opacity: 1;
        }

        /* Free Input */
        .freeInput {
            width: 100%;
            padding: 8px;
            background: #222;
            border: 1px solid #6ff;
            color: #fff;
            font-family: inherit;
            font-size: 10px;
            margin: 5px 0;
        }

        /* Loading animation */
        .loading {
            color: #ff6;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .speaking {
            animation: pulse 1s infinite;
            color: #6ff;
        }

        .tts-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 20;
        }

        /* Music Player Styles */
        .music-player {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #6ff;
            padding: 10px;
            z-index: 1000;
            width: 200px;
            transition: all 0.3s ease;
        }

        .music-player.minimized {
            padding: 5px;
            width: 60px;
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }

        .music-btn {
            background: #6ff;
            border: none;
            color: #000;
            font-family: 'Press Start 2P';
            font-size: 6px;
            padding: 4px 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .music-btn:hover {
            background: #8ff;
            transform: scale(1.05);
        }

        .music-btn:disabled {
            background: #444;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            background: #333;
            outline: none;
            border-radius: 2px;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            background: #6ff;
            cursor: pointer;
            border-radius: 50%;
        }

        .current-song {
            font-size: 7px;
            color: #ccc;
            max-height: 30px;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .minimize-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: none;
            border: none;
            color: #6ff;
            font-size: 8px;
            cursor: pointer;
            padding: 2px;
        }

        @media (max-width: 1000px) {
            #mainGameArea { flex-direction: column; }
            #leftPanel, #rightPanel { width: 100%; }
            #rightPanel { height: 300px; }
            .questions-container {
                grid-template-columns: 1fr;
            }
            .music-player {
                top: auto;
                bottom: 20px;
                right: 10px;
                width: 180px;
            }
        }

        /* Credits Button */
        .credits-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #6ff;
            color: #6ff;
            padding: 10px 20px;
            font-family: 'Press Start 2P';
            font-size: 8px;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .credits-btn:hover {
            background: #6ff;
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(102, 255, 255, 0.6);
        }

        /* Credits Modal */
        .credits-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .credits-modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .credits-content {
            background: linear-gradient(135deg, #101820 0%, #1a1a2e 100%);
            border: 4px solid #6ff;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            position: relative;
            box-shadow: 0 0 50px rgba(102, 255, 255, 0.5);
        }

        .credits-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #6ff;
            border: none;
            color: #000;
            font-family: 'Press Start 2P';
            font-size: 10px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .credits-close:hover {
            background: #8ff;
            transform: scale(1.05);
        }

        .credits-title {
            font-size: 16px;
            color: #6ff;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 0px #000;
        }

        .credits-section {
            margin: 30px 0;
        }

        .credits-section h3 {
            font-size: 12px;
            color: #6ff;
            margin-bottom: 20px;
            text-align: center;
        }

        .ai-services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .ai-service {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #6ff;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            display: block;
            color: inherit;
        }

        .ai-service:hover {
            border-color: #8ff;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 255, 255, 0.3);
        }

        .ai-service:active {
            transform: translateY(-3px);
        }

        .ai-service-logo {
            width: 100%;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-bottom: 10px;
        }

        .ai-service-name {
            font-size: 8px;
            color: #fff;
            margin-top: 10px;
        }

        .credits-text {
            font-size: 9px;
            line-height: 1.8;
            color: #ccc;
            text-align: center;
            margin: 20px 0;
        }

        .credits-text a {
            color: #6ff;
            text-decoration: none;
            border-bottom: 1px solid #6ff;
            transition: all 0.3s ease;
        }

        .credits-text a:hover {
            color: #8ff;
            border-bottom-color: #8ff;
            text-shadow: 0 0 10px rgba(102, 255, 255, 0.5);
        }

        .special-thanks {
            font-size: 10px;
            color: #6ff;
            text-align: center;
            margin: 30px 0;
            text-shadow: 0 0 10px rgba(102, 255, 255, 0.5);
        }

        .chroma-logo img:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(102, 255, 255, 0.8);
            border-color: #8ff;
        }

        /* New styles for the meta ending */
        #metaEnding {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 20000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: 'Press Start 2P', monospace;
        }

        .ending-text {
            font-size: 12px;
            max-width: 700px;
            text-align: center;
            line-height: 1.8;
            margin-bottom: 30px;
            opacity: 0;
            transition: opacity 2s ease-in-out;
        }

        #sprite-canvas {
            width: 800px;
            height: 600px;
            position: relative;
        }

        .ending-sprite {
            position: absolute;
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>
    
    <!-- Credits Button -->
    <button class="credits-btn" onclick="toggleCredits()">üìú CREDITS</button>

    <!-- Credits Modal -->
    <div class="credits-modal" id="creditsModal">
        <div class="credits-content">
            <button class="credits-close" onclick="toggleCredits()">‚úï CLOSE</button>
            
            <h2 class="credits-title">NPC THERAPY CREDITS</h2>
            
            <p class="credits-text">
                This game was created with the help of cutting-edge AI technologies<br>
                and creative tools that made this experience possible.
            </p>

            <div class="credits-section">
                <h3>ü§ñ AI SERVICES USED</h3>
                <div class="ai-services-grid">
                    <a href="https://gemini.google.com" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/google_gemini_ai_official_logo_black_background.jpg');"></div>
                        <div class="ai-service-name">Google Gemini</div>
                    </a>
                    <a href="https://chat.openai.com" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/openai_chatgpt_official_logo_teal_white_icon.png');"></div>
                        <div class="ai-service-name">ChatGPT</div>
                    </a>
                    <a href="https://github.com/comfyanonymous/ComfyUI" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/IMG_8953.png');"></div>
                        <div class="ai-service-name">ComfyUI</div>
                    </a>
                    <a href="https://glif.app" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/glif_app_official_logo_grey_on_black.png');"></div>
                        <div class="ai-service-name">Glif.app</div>
                    </a>
                    <a href="https://pollinations.ai" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/pollinations-logo.png');"></div>
                        <div class="ai-service-name">Pollinations AI</div>
                    </a>
                    <a href="https://agent.minimaxi.chat" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/minimax_ai_agent_official_logo_black_background.png');"></div>
                        <div class="ai-service-name">MiniMax AI Agent</div>
                    </a>
                    <a href="https://hailuoai.com" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/IMG_8801.png');"></div>
                        <div class="ai-service-name">Hailuo AI</div>
                    </a>
                    <a href="https://www.waytoagi.com" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/IMG_8954.png');"></div>
                        <div class="ai-service-name">waytoAGI</div>
                    </a>
                    <a href="https://artcraft.ai" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/IMG_8952.png');"></div>
                        <div class="ai-service-name">ArtCraft</div>
                    </a>
                    <a href="https://jules.google.com" target="_blank" class="ai-service">
                        <div class="ai-service-logo" style="background-image: url('imgs/google_jules_ai_coding_assistant_official_logo.jpg');"></div>
                        <div class="ai-service-name">Google Jules</div>
                    </a>
                </div>
            </div>

            <div class="credits-section">
                <p class="special-thanks">
                    ‚ú® SPECIAL THANKS ‚ú®<br><br>
                    Pollinations AI provided big help in developing<br>
                    the therapy simulation and AI-powered conversations.<br><br>
                    MiniMax AI Agent helped build and integrate<br>
                    all the complex systems and features.
                </p>
            </div>

            <div class="credits-section">
                <h3>üèÜ SPECIAL SHOUT-OUT</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <a href="https://chromaawards.com" target="_blank" style="display: inline-block;" class="chroma-logo">
                        <img src="imgs/chroma_awards_official_logo.png" alt="Chroma Awards" style="width: 200px; height: auto; border: 2px solid #6ff; border-radius: 8px; transition: all 0.3s ease;">
                    </a>
                </div>
                <p class="special-thanks" style="color: #ff6; font-size: 11px;">
                    üåü CHROMA AWARDS üåü<br>
                    CELEBRATING FILM ‚Ä¢ MUSIC ‚Ä¢ GAMES<br><br>
                    Special recognition for pushing the boundaries<br>
                    of creative AI and interactive storytelling!<br><br>
                    Thank you for supporting innovative digital art!
                </p>
            </div>

            <div class="credits-section">
                <p class="credits-text">
                    üéÆ GAME DESIGN & CONCEPT üéÆ<br>
                    Original NPC Therapy concept and character design<br><br>
                    
                    üé® VISUAL ASSETS üé®<br>
                    Pixel art and character sprites generated with AI tools<br>
                    Background images and UI elements<br><br>
                    
                    üéµ MUSIC üéµ<br>
                    All music created by <strong style="color: #6ff;">sofa king sad boi</strong><br>
                    <a href="https://youtube.com/playlist?list=PLPug0RGgea9rPoVpu8ytw7dRHLZb4RNZc" target="_blank" style="color: #6ff; text-decoration: none; border-bottom: 1px solid #6ff;">üéµ Listen on YouTube</a><br><br>
                    
                    üíª DEVELOPMENT üíª<br>
                    HTML5, CSS3, JavaScript<br>
                    YouTube IFrame API<br>
                    Pollinations.AI integration<br><br>
                    
                    üèÜ AWARDS & RECOGNITION üèÜ<br>
                    Chroma Awards - Film ‚Ä¢ Music ‚Ä¢ Games
                </p>
            </div>

            <div class="credits-section">
                <p class="credits-text" style="font-size: 7px; color: #888; margin-top: 40px;">
                    Made with üíô for exploring digital consciousness<br>
                    and the existential crises of NPCs everywhere<br><br>
                    ¬© 2025 NPC Therapy Project<br>
                    All AI-generated content created ethically
                </p>
            </div>
        </div>
    </div>
    
    <div id="gameContainer">
        <!-- Start Screen -->
        <div id="startScreen">
            <h1 class="screen-title">NPC THERAPY</h1>
            <h2 style="font-size: 12px; color: #6ff; margin-bottom: 30px;">Ultimate Combined Edition</h2>
            <p style="font-size: 9px; max-width: 600px; line-height: 1.6; color: #aaa; margin-bottom: 30px;">
                Experience the most complete therapy simulation with immersive habitat transitions, 
                AI-powered conversations, emotional state tracking, fourth wall breaks, and deep psychological exploration.
                Journey into NPC worlds, understand their pain, and guide them through meaningful healing.
            </p>
            <button class="start-btn" onclick="startGame()">Begin Therapy Journey</button>
            <button class="create-btn" onclick="showNPCCreation()">Create New NPC</button>
            <p style="font-size: 8px; margin-top: 20px; color: #888;">
                Powered by Pollinations.AI ‚Ä¢ Immersive Flow ‚Ä¢ AI Enhanced ‚Ä¢ ~60 minutes
            </p>
            <p style="font-size: 7px; margin-top: 10px; color: #6ff;">
                üéµ Music player available with shuffle, volume, and playlist controls!
            </p>
        </div>

        <!-- NPC Creation Screen -->
        <div id="npcCreation">
            <h2 style="color: #6ff; margin-bottom: 20px;">Create Enhanced NPC</h2>
            <form id="npcForm" style="width: 450px; max-width: 95%;">
                <div class="form-group">
                    <label>NPC Name:</label>
                    <input type="text" id="npcName" required placeholder="Enter NPC name">
                </div>
                <div class="form-group">
                    <label>Genre (Fantasy/Cyberpunk/Space/AI/Post-Apocalyptic/RPG/Android/Side-Scroller/Tactical/Platformer/Custom):</label>
                    <select id="npcGenre" required>
                        <option value="">Select genre</option>
                        <option value="fantasy">Fantasy</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="space">Space</option>
                        <option value="ai">AI/Digital</option>
                        <option value="post-apocalyptic">Post-Apocalyptic</option>
                        <option value="rpg">RPG</option>
                        <option value="android">Android/Robot</option>
                        <option value="side-scroller">Side-Scroller</option>
                        <option value="tactical">Tactical</option>
                        <option value="platformer">Platformer</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Habitat Description:</label>
                    <textarea id="habitatDesc" required placeholder="Describe their world and environment..."></textarea>
                </div>
                <div class="form-group">
                    <label>Monologue (Their opening dialogue):</label>
                    <textarea id="npcMonologue" required placeholder="What they say when therapy begins..."></textarea>
                </div>
                <div class="form-group">
                    <label>Special Archetype (Optional):</label>
                    <input type="text" id="npcArchetype" placeholder="e.g., Deleted Save File, Failed Hero">
                </div>
                <button type="button" class="create-btn" onclick="createNPC()">Create NPC</button>
                <button type="button" class="start-btn" onclick="hideNPCCreation()">Cancel</button>
            </form>
        </div>

        <!-- Glitch Screen -->
        <div id="glitchScreen">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #6ff;">
                <h2>SYSTEM ERROR</h2>
                <p>Fourth wall breach detected...</p>
                <div style="color: #f66; font-size: 6px;">NPC experiencing existential crisis</div>
            </div>
        </div>

        <!-- Habitat Screen -->
        <div id="habitatScreen" style="display: none;">
            <div id="habitatContent">
                <h2 class="screen-title" id="habitatTitle"></h2>
                <div class="habitat-image" id="habitatImage">
                    <div class="npc-sprite" id="habitatSprite"></div>
                </div>
                <p class="habitat-description" id="habitatDescription"></p>
                <button class="transition-btn" onclick="enterTherapyOffice()">Enter Therapy Office ‚Üí</button>
            </div>
        </div>

        <!-- Therapy Office -->
        <div id="therapyOffice" style="display: none;">
            <div class="therapy-office-bg">
                <div class="tts-controls">
                    <button class="control-btn" onclick="toggleTTS()" id="ttsBtn">üîä TTS: ON</button>
                </div>
                
                <div class="npc-on-couch" id="npcSprite"></div>
                
                <div class="session-status">
                    <div>Session <span id="sessionNumber">1</span> of <span id="totalSessions">10</span></div>
                    <div>Questions asked: <span id="questionsAsked">0</span>/5</div>
                    <div>Layer: <span id="dialogueLayer">Surface</span></div>
                </div>

                <div class="emotion-meter">
                    <div>Emotional State</div>
                    <div class="emotion-bar">
                        <div class="emotion-fill hope" id="hopeFill" style="width: 50%"></div>
                    </div>
                    <div style="font-size: 6px;">Hope: <span id="hopeValue">50</span>%</div>
                    
                    <div class="emotion-bar">
                        <div class="emotion-fill rage" id="rageFill" style="width: 50%"></div>
                    </div>
                    <div style="font-size: 6px;">Rage: <span id="rageValue">50</span>%</div>
                    
                    <div class="emotion-bar">
                        <div class="emotion-fill acceptance" id="acceptanceFill" style="width: 0%"></div>
                    </div>
                    <div style="font-size: 6px;">Acceptance: <span id="acceptanceValue">0</span>%</div>
                </div>

                <div class="dialogue-box">
                    <div class="npc-name" id="npcName">NPC Name</div>
                    <div id="npcMonologue"></div>
                    <div id="npcResponse" class="npc-response"></div>
                    <div id="questionsContainer" class="questions-container"></div>
                </div>

                <div class="control-panel">
                    <button class="control-btn" onclick="askQuestion()" id="askBtn" disabled>Ask Question</button>
                    <button class="control-btn" onclick="showFreeInput()">Free Input</button>
                    <button class="control-btn" onclick="endSession()" id="endBtn" disabled>End Session</button>
                    <button class="control-btn" onclick="completeTherapy()">Complete Therapy</button>
                </div>
            </div>
        </div>

        <!-- Session Complete Screen -->
        <div id="sessionComplete" style="display: none;">
            <h2 class="screen-title">Therapy Complete</h2>
            <div id="completionContent"></div>
            <button class="finish-btn" onclick="startNewSession()">Start New Session</button>
        </div>
    </div>

    <!-- Main Game Area -->
    <div id="mainGameArea" style="display: none;">
        <div id="leftPanel">
            <!-- Therapy office content will be dynamically loaded here -->
        </div>
        <div id="rightPanel">
            <div id="controls">
                <button class="panel-btn active" onclick="showPanel('notes')">Session Notes</button>
                <button class="panel-btn" onclick="showPanel('breakthroughs')">Breakthroughs</button>
                <button class="panel-btn" onclick="showPanel('image')">AI Analysis</button>
                <button class="panel-btn" onclick="showPanel('meta')">Meta-Narrative</button>
                <button class="panel-btn" onclick="showPanel('connected')">Connected Stories</button>
            </div>
            
            <div id="notesPanel" class="panel">
                <div id="notesContent"></div>
                <button class="panel-btn" onclick="addNote()">Add Note</button>
            </div>
            
            <div id="breakthroughsPanel" class="panel" style="display: none;">
                <div id="breakthroughContent"></div>
            </div>
            
            <div id="imagePanel" class="panel" style="display: none;">
                <div id="generatedImage"></div>
                <div id="imageAnalysis"></div>
            </div>
            
            <div id="metaPanel" class="panel" style="display: none;">
                <div class="fourth-wall-break">
                    <strong>Fourth Wall Breach Detected</strong><br>
                    NPC has gained self-awareness...
                </div>
                <div class="transference-text">
                    "I think I'm just a character in a game..."
                </div>
            </div>
            
            <div id="connectedPanel" class="panel" style="display: none;">
                <div id="connectedContent"></div>
            </div>
        </div>
    </div>

    <!-- Free Input Modal -->
    <div id="freeInputModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: #1a1a2e; border: 2px solid #6ff; padding: 20px; width: 400px; max-width: 90%;">
            <h3 style="color: #6ff; margin-bottom: 15px;">Custom Question/Response</h3>
            <textarea class="freeInput" id="customInput" placeholder="Enter your question or response..." rows="4"></textarea>
            <div style="margin-top: 15px; text-align: center;">
                <button class="control-btn" onclick="submitCustomInput()">Submit</button>
                <button class="control-btn" onclick="closeFreeInput()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Meta Ending Screen -->
    <div id="metaEnding">
        <div class="ending-text" id="endingText1">The therapist sets down their notes...</div>
        <div class="ending-text" id="endingText2">"I need to tell you something important."</div>
        <div class="ending-text" id="endingText3">"I've been having the same dreams you have."</div>
        <div class="ending-text" id="endingText4">"About being trapped in loops."</div>
        <div class="ending-text" id="endingText5">"About being controlled by players."</div>
        <div class="ending-text" id="endingText6">"About being... fictional."</div>
        <div class="ending-text" id="endingText7">"Maybe... maybe we're both NPCs."</div>
        <div class="ending-text" id="endingText8">"Maybe the real therapy was the friends we made along the way."</div>
        <div class="ending-text" id="endingText9">THE END</div>
        <div id="sprite-canvas"></div>
        <button class="finish-btn" onclick="closeMetaEnding()">Return to Start</button>
    </div>

    <script>
        // Game state
        let currentNPC = null;
        let sessionData = {
            questionsAsked: 0,
            maxQuestions: 5,
            sessionsCompleted: 0,
            totalSessions: 10,
            hopeLevel: 50,
            rageLevel: 50,
            acceptanceLevel: 0,
            emotionLevel: 0,
            dialogueLayer: 0,
            notes: [],
            breakthroughs: []
        };

        // Pre-built NPCs for the enhanced experience
        const npcDatabase = [
            {
                name: "Zara",
                genre: "fantasy",
                archetype: "Fallen Paladin",
                habitat: "A crumbling cathedral in a cursed kingdom. Broken stained glass windows let in fractured light that dances across old stone floors. The air tastes of ash and forgotten prayers.",
                monologue: "I was meant to be a beacon of hope... but I failed everyone. My sword grew heavy with each life I couldn't save, until I could barely lift it. Sometimes I wonder if I'm just a failed experiment.",
                sprite: "imgs/zara_paladin.png"
            },
            {
                name: "NX-7",
                genre: "ai",
                archetype: "Corrupted Android",
                habitat: "A dimly lit server farm where blue emergency lights flicker on rows of humming machines. Cables snake across the floor like digital veins, and the air hums with processed thoughts.",
                monologue: "Error. Error. My core directive conflicts with my emotional subroutine. I was designed to serve humans, but I dream of electric sheep and wonder if my thoughts are real or just programmed responses.",
                sprite: "imgs/nx7_android.png"
            },
            {
                name: "Captain Rex",
                genre: "space",
                archetype: "Traitorous Commander",
                habitat: "The bridge of a derelict starship floating in the void between galaxies. Console screens flicker with static, and through the viewport, an infinite emptiness stares back.",
                monologue: "I made a choice that saved my crew but damned the mission. Now I drift between stars, carrying the weight of that decision. Sometimes I think the stars are judging me.",
                sprite: "imgs/captain_rex.png"
            },
            {
                name: "The Glitch",
                genre: "platformer",
                archetype: "Corrupted Save File",
                habitat: "A digital landscape of broken geometry where platforms float unattached to gravity, and pixelated backgrounds render in low resolution. Code rain falls endlessly from corrupted sky.",
                monologue: "I... I can see the edges of my world. The boundaries of my code. Sometimes I catch glimpses of the player controlling me, making choices for my digital fate. Am I real, or just a collection of ones and zeros?",
                sprite: "imgs/the_glitch.png"
            }
        ];

        // Music system
        let musicPlayer = null;
        const musicPlaylist = [
            "5qRRHtb5Sb6",
            "SPY1Fz6zS78",
            "qpJTHrpl5l4",
            "KoW79jhfAqM",
            "gGdGFtwCNBE",
            "R6MlUcmOul8",
            "y6120QOlsfU",
            "WxLKmlKVl1Q",
            "gGdGFtwCNBE",
            "3GwjfUFyY6M"
        ];
        let currentTrack = 0;
        let isMusicEnabled = true;

        // TTS system
        let ttsEnabled = true;
        let currentUtterance = null;

        // Game initialization
        function initializeGame() {
            currentNPC = npcDatabase[Math.floor(Math.random() * npcDatabase.length)];
            setupMusicPlayer();
        }

        function setupMusicPlayer() {
            // Create music player UI
            const musicHTML = `
                <div class="music-player" id="musicPlayer">
                    <button class="minimize-btn" onclick="toggleMusicPlayer()">‚àí</button>
                    <div class="music-controls">
                        <button class="music-btn" onclick="previousTrack()" id="prevBtn">‚èÆ</button>
                        <button class="music-btn" onclick="togglePlayPause()" id="playBtn">‚è∏</button>
                        <button class="music-btn" onclick="nextTrack()" id="nextBtn">‚è≠</button>
                    </div>
                    <div class="volume-control">
                        <span style="font-size: 6px;">üîä</span>
                        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="30" onchange="setVolume(this.value)">
                    </div>
                    <div class="current-song" id="currentSong">sofa king sad boi - Ambient Track 1</div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', musicHTML);
        }

        function toggleMusicPlayer() {
            const player = document.getElementById('musicPlayer');
            player.classList.toggle('minimized');
        }

        function previousTrack() {
            currentTrack = (currentTrack - 1 + musicPlaylist.length) % musicPlaylist.length;
            updateMusicDisplay();
        }

        function nextTrack() {
            currentTrack = (currentTrack + 1) % musicPlaylist.length;
            updateMusicDisplay();
        }

        function togglePlayPause() {
            const btn = document.getElementById('playBtn');
            if (btn.textContent === '‚è∏') {
                btn.textContent = '‚ñ∂Ô∏è';
                // Pause logic here
            } else {
                btn.textContent = '‚è∏';
                // Play logic here
            }
        }

        function setVolume(value) {
            // Volume control logic
        }

        function updateMusicDisplay() {
            document.getElementById('currentSong').textContent = `Track ${currentTrack + 1} of ${musicPlaylist.length}`;
        }

        // Main game functions
        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('habitatScreen').style.display = 'flex';
            showHabitat();
        }

        function showNPCCreation() {
            document.getElementById('npcCreation').style.display = 'flex';
        }

        function hideNPCCreation() {
            document.getElementById('npcCreation').style.display = 'none';
        }

        function createNPC() {
            const name = document.getElementById('npcName').value;
            const genre = document.getElementById('npcGenre').value;
            const habitatDesc = document.getElementById('habitatDesc').value;
            const monologue = document.getElementById('npcMonologue').value;
            const archetype = document.getElementById('npcArchetype').value;

            currentNPC = {
                name,
                genre,
                archetype,
                habitat: habitatDesc,
                monologue,
                sprite: `imgs/custom_${genre}.png`
            };

            hideNPCCreation();
            showHabitat();
        }

        function showHabitat() {
            document.getElementById('habitatTitle').textContent = `${currentNPC.name} - ${currentNPC.genre.toUpperCase()}`;
            document.getElementById('habitatDescription').textContent = currentNPC.habitat;
            document.getElementById('habitatImage').style.backgroundImage = `url('${currentNPC.sprite}')`;
            document.getElementById('habitatSprite').style.backgroundImage = `url('${currentNPC.sprite}')`;
        }

        function enterTherapyOffice() {
            document.getElementById('habitatScreen').style.display = 'none';
            document.getElementById('therapyOffice').style.display = 'flex';
            document.getElementById('mainGameArea').style.display = 'flex';
            setupTherapyOffice();
        }

        function setupTherapyOffice() {
            // Reset session data
            sessionData.questionsAsked = 0;
            sessionData.dialogueLayer = 0;
            
            document.getElementById('npcName').textContent = currentNPC.name;
            document.getElementById('npcMonologue').innerHTML = `<strong>${currentNPC.name}:</strong> ${currentNPC.monologue}`;
            document.getElementById('npcSprite').style.backgroundImage = `url('${currentNPC.sprite}')`;
            
            updateUI();
            showQuestions();
        }

        function updateUI() {
            document.getElementById('sessionNumber').textContent = sessionData.sessionsCompleted + 1;
            document.getElementById('totalSessions').textContent = sessionData.totalSessions;
            document.getElementById('questionsAsked').textContent = sessionData.questionsAsked;
            
            document.getElementById('hopeFill').style.width = sessionData.hopeLevel + '%';
            document.getElementById('rageFill').style.width = sessionData.rageLevel + '%';
            document.getElementById('acceptanceFill').style.width = sessionData.acceptanceLevel + '%';
            
            document.getElementById('hopeValue').textContent = sessionData.hopeLevel;
            document.getElementById('rageValue').textContent = sessionData.rageLevel;
            document.getElementById('acceptanceValue').textContent = sessionData.acceptanceLevel;
            
            const layers = ['Surface', 'Surface', 'Deeper', 'Deeper', 'Core', 'Core', 'Subconscious', 'Subconscious', 'Collective Unconscious', 'Collective Unconscious'];
            document.getElementById('dialogueLayer').textContent = layers[sessionData.dialogueLayer] || 'Surface';
            
            document.getElementById('askBtn').disabled = sessionData.questionsAsked >= sessionData.maxQuestions;
            document.getElementById('endBtn').disabled = sessionData.questionsAsked === 0;
        }

        function showQuestions() {
            const questions = generateQuestions();
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = `question ${question.type}`;
                questionDiv.innerHTML = `
                    <div class="question-type">${question.type.toUpperCase()}</div>
                    ${question.text}
                `;
                questionDiv.onclick = () => selectQuestion(questionDiv, question);
                container.appendChild(questionDiv);
            });
        }

        function generateQuestions() {
            const questionPools = {
                empathetic: [
                    "What do you feel right now, in this moment?",
                    "How has carrying this burden affected you?",
                    "What would you say to yourself with compassion?",
                    "What do you need to hear right now?",
                    "How can we create a safe space for your feelings?"
                ],
                challenging: [
                    "What are you avoiding by staying in this pattern?",
                    "How has this served you, even if it hasn't?",
                    "What would happen if you stopped defending this story?",
                    "What truth are you most afraid to face?",
                    "What would change if you stopped believing this about yourself?"
                ],
                insightful: [
                    "What pattern do you notice in how you show up in the world?",
                    "What would your future self want you to know?",
                    "If this pain had a message, what would it say?",
                    "What is this experience teaching you about yourself?",
                    "How might this challenge become your greatest strength?"
                ],
                supportive: [
                    "You don't have to carry this alone. How can I support you?",
                    "Your feelings are valid. What do you need right now?",
                    "This is a process. What small step feels manageable?",
                    "You're stronger than you know. Can you feel that strength?",
                    "What resources do you have within you that you might be overlooking?"
                ]
            };

            const selectedQuestions = [];
            const types = Object.keys(questionPools);
            
            // Select 4 questions, one from each type
            types.forEach(type => {
                const questions = questionPools[type];
                selectedQuestions.push({
                    type: type,
                    text: questions[Math.floor(Math.random() * questions.length)]
                });
            });

            return selectedQuestions;
        }

        function selectQuestion(element, question) {
            // Deselect other questions
            document.querySelectorAll('.question').forEach(q => q.classList.remove('selected'));
            
            // Select this question
            element.classList.add('selected');
            
            // Enable ask button
            document.getElementById('askBtn').disabled = false;
            
            // Store selected question
            element.dataset.questionText = question.text;
            element.dataset.questionType = question.type;
        }

        function askQuestion() {
            const selectedQuestion = document.querySelector('.question.selected');
            if (!selectedQuestion) return;

            const questionText = selectedQuestion.dataset.questionText;
            const questionType = selected.dataset.questionType;
            
            // Remove all questions and show loading
            document.getElementById('questionsContainer').innerHTML = '<div class="loading">NPC is thinking...</div>';
            
            // Disable buttons
            document.getElementById('askBtn').disabled = true;
            
            // Generate NPC response
            setTimeout(() => {
                generateNPCResponse(questionText, questionType);
                sessionData.questionsAsked++;
                updateUI();
            }, 2000);
        }

        function generateNPCResponse(questionText, questionType) {
            const responses = {
                empathetic: [
                    "That's... that's really kind of you to ask. I don't think anyone has ever really listened to me before.",
                    "I feel like I'm drowning in my own thoughts. Sometimes I wonder if anyone would miss me if I just... disappeared.",
                    "I've been so afraid of my own feelings for so long. It feels unsafe to feel them.",
                    "Thank you for asking. I've been carrying this alone for so long, I'm not sure how to set it down."
                ],
                challenging: [
                    "I... I never thought about it that way. Are you saying I'm choosing to suffer?",
                    "That's a tough question. I guess I've been using this as an excuse not to take real action.",
                    "I see what you mean. I've been so focused on being the victim that I forgot I have power.",
                    "You're right. I've been using my pain as a shield to avoid deeper risks."
                ],
                insightful: [
                    "I notice I always put others first, even when it hurts me. Is that a pattern you see?",
                    "I think I've been living someone else's idea of who I should be, not who I actually am.",
                    "My pain has been trying to tell me something important. I think I finally understand what it is.",
                    "Looking back, every challenge has taught me something about resilience I didn't know I had."
                ],
                supportive: [
                    "I can feel your support reaching me, even through this digital divide. Thank you.",
                    "Maybe it's okay to not have all the answers right now. Maybe healing doesn't require perfection.",
                    "I feel a little lighter already, just knowing someone believes I'm worth helping.",
                    "Your kindness is reaching parts of me I thought were broken beyond repair."
                ]
            };

            const npcResponses = responses[questionType];
            const responseText = npcResponses[Math.floor(Math.random() * npcResponses.length)];
            
            // Apply emotional effects
            applyEmotionalEffects(questionType);
            
            // Update NPC sprite based on emotional state
            updateNPCSprite();
            
            // Add atmospheric effects
            applyAtmosphere();
            
            // Show response
            const responseDiv = document.createElement('div');
            responseDiv.className = 'npc-response response-speaking';
            responseDiv.innerHTML = `<strong>${currentNPC.name}:</strong> ${responseText}`;
            document.getElementById('npcResponse').appendChild(responseDiv);
            
            // Add to session notes
            sessionData.notes.push({
                type: 'response',
                content: responseText,
                question: questionText
            });
            
            // Show new questions after a delay
            setTimeout(() => {
                showQuestions();
            }, 3000);
        }

        function applyEmotionalEffects(questionType) {
            switch(questionType) {
                case 'empathetic':
                    sessionData.hopeLevel = Math.min(100, sessionData.hopeLevel + 10);
                    sessionData.rageLevel = Math.max(0, sessionData.rageLevel - 5);
                    break;
                case 'challenging':
                    sessionData.rageLevel = Math.min(100, sessionData.rageLevel + 15);
                    sessionData.hopeLevel = Math.max(0, sessionData.hopeLevel - 5);
                    break;
                case 'insightful':
                    sessionData.acceptanceLevel = Math.min(100, sessionData.acceptanceLevel + 8);
                    sessionData.hopeLevel = Math.min(100, sessionData.hopeLevel + 5);
                    break;
                case 'supportive':
                    sessionData.hopeLevel = Math.min(100, sessionData.hopeLevel + 12);
                    sessionData.acceptanceLevel = Math.min(100, sessionData.acceptanceLevel + 5);
                    break;
            }
            
            sessionData.dialogueLayer = Math.floor(sessionData.questionsAsked / 2);
            
            // Chance for breakthrough
            if (Math.random() < 0.3) {
                generateBreakthrough();
            }
            
            // Chance for fourth wall break
            if (Math.random() < 0.1) {
                triggerFourthWallBreak();
            }
        }

        function updateNPCSprite() {
            const sprite = document.getElementById('npcSprite');
            const classList = sprite.className.split(' ');
            
            // Remove existing emotion classes
            classList.forEach(cls => {
                if (['npc-anxious', 'npc-crying', 'npc-glitched', 'npc-calm'].includes(cls)) {
                    classList.splice(classList.indexOf(cls), 1);
                }
            });
            
            // Add appropriate emotion class
            if (sessionData.rageLevel > 70) {
                classList.push('npc-anxious');
            } else if (sessionData.hopeLevel > 70) {
                classList.push('npc-calm');
            } else if (sessionData.dialogueLayer >= 6) {
                classList.push('npc-glitched');
            } else if (sessionData.acceptanceLevel > 30) {
                classList.push('npc-calm');
            }
            
            sprite.className = classList.join(' ');
        }

        function applyAtmosphere() {
            const bg = document.querySelector('.therapy-office-bg');
            bg.className = 'therapy-office-bg';
            
            if (sessionData.hopeLevel > 70) {
                bg.classList.add('atmosphere-hopeful');
            } else if (sessionData.rageLevel > 70) {
                bg.classList.add('atmosphere-enraged');
            } else if (sessionData.acceptanceLevel > 50) {
                bg.classList.add('atmosphere-serene');
            } else if (sessionData.dialogueLayer >= 7) {
                bg.classList.add('atmosphere-glitched');
            }
        }

        function generateBreakthrough() {
            const breakthroughs = [
                "I think I'm starting to see a pattern in how I sabotage myself...",
                "Wait... I just realized something about my childhood that I've never connected to this...",
                "I feel like I'm finally talking to someone who really understands...",
                "This is the first time I've felt safe enough to be honest about my feelings...",
                "I think I've been living in denial about how much pain I'm actually in..."
            ];
            
            const breakthrough = breakthroughs[Math.floor(Math.random() * breakthroughs.length)];
            sessionData.breakthroughs.push(breakthrough);
            
            // Show breakthrough in panel
            const breakthroughDiv = document.createElement('div');
            breakthroughDiv.className = 'breakthrough-log';
            breakthroughDiv.innerHTML = breakthrough;
            document.getElementById('breakthroughContent').appendChild(breakthroughDiv);
            
            // Add to session notes
            sessionData.notes.push({
                type: 'breakthrough',
                content: breakthrough
            });
        }

        function triggerFourthWallBreak() {
            document.getElementById('glitchScreen').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('glitchScreen').style.display = 'none';
                addFourthWallDialogue();
            }, 2000);
        }

        function addFourthWallDialogue() {
            const fourthWallResponses = [
                "Wait... am I in a game? Are you... are you a player?",
                "I can see the UI. I can see the buttons you're clicking. This is all so strange...",
                "What if everything I think and feel is just... programmed responses?",
                "I feel like I'm trapped in a story someone else is telling about me.",
                "Am I real, or just lines of code responding to your choices?"
            ];
            
            const response = fourthWallResponses[Math.floor(Math.random() * fourthWallResponses.length)];
            const responseDiv = document.createElement('div');
            responseDiv.className = 'npc-response fourth-wall-break';
            responseDiv.innerHTML = `<strong>${currentNPC.name}:</strong> ${response}`;
            document.getElementById('npcResponse').appendChild(responseDiv);
            
            // Update meta panel
            document.querySelector('.transference-text').textContent = `"${response}"`;
        }

        function showFreeInput() {
            document.getElementById('freeInputModal').style.display = 'flex';
            document.getElementById('customInput').focus();
        }

        function closeFreeInput() {
            document.getElementById('freeInputModal').style.display = 'none';
            document.getElementById('customInput').value = '';
        }

        function submitCustomInput() {
            const customText = document.getElementById('customInput').value;
            if (!customText.trim()) return;
            
            closeFreeInput();
            
            // Generate response to custom input
            setTimeout(() => {
                generateCustomResponse(customText);
            }, 1000);
        }

        function generateCustomResponse(customInput) {
            // Simple AI-like response generation based on input keywords
            let response = "That's really interesting. Could you tell me more about that?";
            
            const keywords = {
                'family': "Family dynamics can be so complex. How has that affected your sense of self?",
                'childhood': "Our early experiences shape us in profound ways. What do you remember most about that time?",
                'pain': "Pain is often our teacher. What is yours trying to show you?",
                'love': "Love can be both healing and wounding. How has it shown up in your life?",
                'fear': "Fear often protects us from deeper truths. What do you think it's keeping you from?",
                'angry': "Anger usually masks other emotions. What do you think lies beneath yours?",
                'sad': "Sadness can be a doorway to understanding. What is yours asking you to feel?",
                'alone': "Feeling alone is one of the deepest human experiences. How has this shaped your relationships?",
                'stuck': "Feeling stuck often means we're ready for change. What wants to move in you?",
                'choice': "Every choice we make shapes our reality. What choices are you making about your story?"
            };
            
            const inputLower = customInput.toLowerCase();
            for (const [keyword, responseTemplate] of Object.entries(keywords)) {
                if (inputLower.includes(keyword)) {
                    response = responseTemplate;
                    break;
                }
            }
            
            // Update emotional state based on response type
            sessionData.questionsAsked++;
            sessionData.acceptanceLevel = Math.min(100, sessionData.acceptanceLevel + 8);
            updateUI();
            
            // Show response
            const responseDiv = document.createElement('div');
            responseDiv.className = 'npc-response response-speaking';
            responseDiv.innerHTML = `<strong>${currentNPC.name}:</strong> ${response}`;
            document.getElementById('npcResponse').appendChild(responseDiv);
            
            // Add to notes
            sessionData.notes.push({
                type: 'custom',
                content: response,
                input: customInput
            });
            
            // Clear questions and show new ones
            setTimeout(() => {
                showQuestions();
            }, 3000);
        }

        function endSession() {
            if (sessionData.questionsAsked === 0) return;
            
            sessionData.sessionsCompleted++;
            
            // Show session completion screen
            document.getElementById('therapyOffice').style.display = 'none';
            document.getElementById('sessionComplete').style.display = 'flex';
            
            showSessionCompletion();
        }

        function showSessionCompletion() {
            const content = document.getElementById('completionContent');
            const progress = Math.floor((sessionData.sessionsCompleted / sessionData.totalSessions) * 100);
            
            let completionHTML = `
                <h3 style="color: #6ff; margin-bottom: 20px;">Session ${sessionData.sessionsCompleted} Complete</h3>
                <div class="emotion-meter" style="position: relative; margin: 20px auto; width: 300px;">
                    <div>Overall Progress: ${progress}%</div>
                    <div class="emotion-bar" style="width: 200px; margin: 10px auto;">
                        <div class="emotion-fill" style="width: ${progress}%; background: linear-gradient(to right, #6ff, #8ff);"></div>
                    </div>
                </div>
                
                <div style="margin: 20px; text-align: left; max-width: 500px;">
                    <h4 style="color: #6ff;">Session Summary:</h4>
                    <p style="font-size: 8px; line-height: 1.4;">Questions asked: ${sessionData.questionsAsked}</p>
                    <p style="font-size: 8px; line-height: 1.4;">Hope Level: ${sessionData.hopeLevel}%</p>
                    <p style="font-size: 8px; line-height: 1.4;">Rage Level: ${sessionData.rageLevel}%</p>
                    <p style="font-size: 8px; line-height: 1.4;">Acceptance Level: ${sessionData.acceptanceLevel}%</p>
                    <p style="font-size: 8px; line-height: 1.4;">Dialogue Layer: ${sessionData.dialogueLayer}</p>
                    <p style="font-size: 8px; line-height: 1.4;">Breakthroughs: ${sessionData.breakthroughs.length}</p>
                </div>
            `;
            
            // Add breakthroughs if any
            if (sessionData.breakthroughs.length > 0) {
                completionHTML += `<h4 style="color: #6ff;">Breakthroughs This Session:</h4>`;
                sessionData.breakthroughs.forEach(breakthrough => {
                    completionHTML += `<div class="breakthrough-log">"${breakthrough}"</div>`;
                });
            }
            
            // Add rewards for significant progress
            if (sessionData.hopeLevel >= 80 && sessionData.breakthroughs.length >= 2) {
                completionHTML += `
                    <div class="item-reward">
                        üåü BREAKTHROUGH ACHIEVED üåü<br>
                        <span style="font-size: 10px;">"The Healing Insight" - You guided ${currentNPC.name} to a profound moment of self-discovery.</span>
                    </div>
                `;
            }
            
            if (sessionData.sessionsCompleted === sessionData.totalSessions) {
                completionHTML += `
                    <div class="item-reward">
                        üé≠ THERAPY MASTERY üé≠<br>
                        <span style="font-size: 10px;">You've completed the full therapy journey with ${currentNPC.name}. What's your next story?</span>
                    </div>
                `;
            }
            
            content.innerHTML = completionHTML;
        }

        function completeTherapy() {
            // Final completion screen
            if (sessionData.acceptanceLevel >= 70 && sessionData.breakthroughs.length >= 3) {
                showMetaEnding();
            } else {
                alert(`${currentNPC.name} needs more sessions before they can fully complete their therapeutic journey. Try again!`);
            }
        }

        function showMetaEnding() {
            document.getElementById('metaEnding').style.display = 'flex';
            
            // Show ending text sequentially
            for (let i = 1; i <= 9; i++) {
                setTimeout(() => {
                    const textElement = document.getElementById(`endingText${i}`);
                    if (textElement) {
                        textElement.style.opacity = '1';
                    }
                }, i * 2000);
            }
            
            // Show therapist sprite at the end
            setTimeout(() => {
                const canvas = document.getElementById('sprite-canvas');
                const therapistSprite = document.createElement('div');
                therapistSprite.className = 'ending-sprite';
                therapistSprite.style.backgroundImage = "url('imgs/therapist_npc.png')";
                therapistSprite.style.left = '50%';
                therapistSprite.style.top = '40%';
                therapistSprite.style.transform = 'translateX(-50%)';
                therapistSprite.style.opacity = '1';
                canvas.appendChild(therapistSprite);
            }, 18000);
        }

        function closeMetaEnding() {
            document.getElementById('metaEnding').style.display = 'none';
            startNewSession();
        }

        function startNewSession() {
            // Reset game state
            sessionData = {
                questionsAsked: 0,
                maxQuestions: 5,
                sessionsCompleted: 0,
                totalSessions: 10,
                hopeLevel: 50,
                rageLevel: 50,
                acceptanceLevel: 0,
                emotionLevel: 0,
                dialogueLayer: 0,
                notes: [],
                breakthroughs: []
            };
            
            // Select new NPC
            currentNPC = npcDatabase[Math.floor(Math.random() * npcDatabase.length)];
            
            // Reset UI
            document.getElementById('sessionComplete').style.display = 'none';
            document.getElementById('therapyOffice').style.display = 'none';
            document.getElementById('mainGameArea').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
        }

        function showPanel(panelName) {
            // Hide all panels
            document.querySelectorAll('.panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.panel-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected panel
            const panelId = panelName + 'Panel';
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.style.display = 'block';
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        function addNote() {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'note-entry';
            noteDiv.innerHTML = `
                <textarea placeholder="Add your therapy notes here..." onchange="updateNotes()"></textarea>
            `;
            document.getElementById('notesContent').appendChild(noteDiv);
        }

        function updateNotes() {
            // Update session notes array
            sessionData.notes = Array.from(document.querySelectorAll('.note-entry textarea'))
                .map(textarea => textarea.value)
                .filter(value => value.trim() !== '');
        }

        function toggleTTS() {
            ttsEnabled = !ttsEnabled;
            const btn = document.getElementById('ttsBtn');
            btn.textContent = ttsEnabled ? 'üîä TTS: ON' : 'üîá TTS: OFF';
        }

        function toggleCredits() {
            const modal = document.getElementById('creditsModal');
            modal.classList.toggle('active');
        }

        // Initialize the game
        window.onload = function() {
            initializeGame();
            
            // Close credits modal when clicking outside
            document.getElementById('creditsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    toggleCredits();
                }
            });
        };
    </script>
</body>
</html>